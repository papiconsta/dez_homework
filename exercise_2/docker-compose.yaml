services:

  kestra_postgres:
    image: postgres:18
    volumes:
      - kestra_postgres_data:/var/lib/postgresql
    environment:
      POSTGRES_DB: kestra
      POSTGRES_USER: kestra
      POSTGRES_PASSWORD: k3str4
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
      interval: 30s
      timeout: 10s
      retries: 10
    networks:
      - pg-network

  kestra:
    image: kestra/kestra:v1.1
    pull_policy: always
    # Note that this setup with a root user is intended for development purpose.
    # Our base image runs without root, but the Docker Compose implementation needs root to access the Docker socket
    # To run Kestra in a rootless mode in production, see: https://kestra.io/docs/installation/podman-compose
    user: "root"
    command: server standalone
    volumes:
      - kestra_data:/app/storage
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/kestra-wd:/tmp/kestra-wd
    environment:
      SECRET_GCP_CREDENTIALS: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiZ3JlZW50YXhpZGV6IiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiYmY1ZGM5ZTM5MjM4YzY0MTFiNGMyYTg5ZDczNDkzNzZkOGRhN2ZmMCIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZBSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS1l3Z2dTaUFnRUFBb0lCQVFDMUtVR3dscW9oTjRmSlxuSGFqTE0wbkpJQ1ZOVEFDMC9TUXZ6VXFXblVHZDE3U0xJaU9HMitPamxRRFlPY1pzZk9kMXVZZ0RsY0hCaXVjRVxuRWk3ajNQQTdhaFVFOG9SdklmcWo2anlvZDBmOVFTUFhOTVZkem9ER1l0MklKTzBUZDllbDNCeWIxNnR3Z1RzWVxuNlUxSndPdkQyYlp3NHZhYVpOV1FXY2dlT1NXcWJzT1BkWjg5bGdHNjYwVzlkN2V2MUJDREVQZjloK3kzQSt4TFxuc2ZFbHNweUFhU2hiOUtUOXpsWGlzcVA0d0hOMWRqamJqc0dnL1Raays4VlUyV1BNTXk5bUp0ODBxNENiaWJhSVxuMDdVZXVibTQ1U1YrNm9LK3NKTU8vU2lmREVDaHNZNGlxaWczQWJMcUFnQTJCTnpZbGlzQVNkdm1EU3kyYVFaOFxuWEJWRlp0MDVBZ01CQUFFQ2dnRUFCcmxGSmtFVFI2Z1VWclV1ZVhzNTlQaG4xZ1I0L3I2cCtBbTRKOXFtajYyTVxudG9EQi9ZeDkrSWxzVm5vZmVKR1N0Q0o2anpxQXpsYUIwRHQrQ01nL2xNN3hRSVdoUDNBdENhWWxFZklhWm9hRFxuUm1hZm9DV016MEFtWFhvVVgvMTUwQjY1STVvWHMzVmliSUJsTlZSdkU2M3FDT3JOa1FtbXlRU2lDaWdnRXlFWVxuOHFmNm02aUFEYURZeklXQk0vSEVzbU1pQXFYc2pqdjVybW91ZmFVQTVuZUJWd1F1NGEyTnNVY1Q1SlhHWTBQRlxudE5qaXJIRDBOb1U1WXhmK0tYQzBZQnViYmVPcjFWRVFvbzhjemZNSG1RZEdhR1E0VytvK3Q1N3dxemErS3VxOFxuTlVvWitIMkJibnBHMGwxdkZrVnV5MGlQYk1XUUNZY3RIZXZjZkxMOUFRS0JnUUR4cnQ3dEFmSkNIN1R0NGREWFxuK0EzNUpCbU40eXl5NkRqZzJyM2pweEpONlQ3dmpkRE90azBKelhQZzM4YUNQR2Y5SEttUFpIcGVPRi9WRThKUVxuYTVQNGdtcDk5SHNnb0xUUWVscmEvL29WTjN6Z01wczFxbnVUNG03N05lb3pYbmZUUW1rd3NEQWcxbEsrb0xiU1xub1pTL2U2YVdLcEorTXpnVi8xRFplSmtjT1FLQmdRQy81SkhHUVVKTE9xaWl5QWZqVUpVTFpWb1JZOEtFYzE2cFxua3JuSU8vQ1E4NmtlRHAxTmY4NU1pTytMdTlRTEI4ODdwQm1zUEYyNmlXclBvanVIcnEwMGtVMlR5R1RzSGd3bFxuTGJEektaRW9jSWRQNWJoVEJqbDdicUpHZnZFTHAyZU5SbkU0dDZzNndBRW96eGtVVmlGWHFBUWQrdGJWRTIrWlxuUkpnbjNNM0pBUUtCZ0FOR1UwN3l6ODJGa0hZSXNVTzc0TFNYZ0tFaml0K0J0Z09WOHl5NmZzei9kQkxhNFJGclxuOXU5REVXYmlvVlh5YTVaS1pTSEVRc1EwRDFoYnhDNUN4dVovSGVKSEJjUVRhVi9KeUtGZkJveHpEQVlkcVd5NFxudXFQdVZZS2g0R0tCelMzWG9JVkFYZWFVQU5zRVluWElLclBOZ1J4WHgxUmViVXdmQVlGdzJPSkJBb0dBZXRDMlxud0JYYWNUMnMydXA5cWU1VVJrUHEvb0JENmZQUkhXVU1ST3lnRHBYMG9va21Bb2tQSjRycERoejhITWMxeW0xQVxuQlMxcHE4N3hyc3lkbnp5Y0hLMzI0ZVA3TytnTFMreFBlWUljSnE3RzI4c2lTdmtMNTBVcTFVVy96djZvMXhIRFxudTFKS1pFS3BPMDQ1TmZ2ZVFUVUcxWTFLM0hzaERRNks5OUJwWVFFQ2dZQm51UC9DaUs3TUQ2WjQ1TW9DejUyYVxuS1M4UGpOMEppQTh6U1AyVkZwUjNZUzZwbjdWaGJlMFBNUWRzTzBJNzdFQTYxZ2J0T0NXQzdBVG45SXVxUEhsNVxuenl3cUEyeDFhbHIzQ3pER1R5QzQvZDAvYzk1TDVhQWladjFQak50dVRpeUprVWlYdkJvc0tNbHZNV0FhZ3ZxbVxubHFxUk9VVXRoYkFpWElKeVBwWEw4Zz09XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAia2VzdHJhLWFjY0BncmVlbnRheGlkZXouaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJjbGllbnRfaWQiOiAiMTEwNTM5NjcwOTQ4MzI5MDE5MzQ2IiwKICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLAogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLAogICJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwKICAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9rZXN0cmEtYWNjJTQwZ3JlZW50YXhpZGV6LmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAidW5pdmVyc2VfZG9tYWluIjogImdvb2dsZWFwaXMuY29tIgp9Cg==
      KESTRA_CONFIGURATION: |
        datasources:
          postgres:
            url: jdbc:postgresql://kestra_postgres:5432/kestra
            driverClassName: org.postgresql.Driver
            username: kestra
            password: k3str4
        kestra:
          server:
            basicAuth:
              username: "admin@kestra.io" # it must be a valid email address
              password: Admin1234
          repository:
            type: postgres
          storage:
            type: local
            local:
              basePath: "/app/storage"
          queue:
            type: postgres
          tasks:
            tmpDir:
              path: /tmp/kestra-wd/tmp
          url: http://localhost:8080/
    ports:
      - "8080:8080"
      - "8081:8081"
    depends_on:
      kestra_postgres:
        condition: service_started
    networks:
      - pg-network


volumes:
  kestra_postgres_data:
    driver: local
  kestra_data:
    driver: local

networks:
  pg-network:
    external: true
    name: pg-network